var _a;
import { DOC_ORIENTATION } from './models/DOC_ORIENTATION';
export class ImageCompress {
}
_a = ImageCompress;
ImageCompress.getOrientation = (file) => new Promise((resolve, reject) => {
    try {
        const reader = new FileReader();
        reader.onload = () => {
            const view = new DataView(reader.result);
            if (!view.byteLength) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            if (view.getUint16(0, false) !== 0xffd8) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            const length = view.byteLength;
            let offset = 2;
            while (offset < length) {
                const marker = view.getUint16(offset, false);
                offset += 2;
                if (marker === 0xffe1) {
                    if (view.getUint32((offset += 2), false) !== 0x45786966) {
                        return resolve(DOC_ORIENTATION.NotJpeg);
                    }
                    const little = view.getUint16((offset += 6), false) === 0x4949;
                    offset += view.getUint32(offset + 4, little);
                    const tags = view.getUint16(offset, little);
                    offset += 2;
                    for (let i = 0; i < tags; i++) {
                        if (view.getUint16(offset + i * 12, little) === 0x0112) {
                            return resolve(view.getUint16(offset + i * 12 + 8, little));
                        }
                    }
                }
                else if ((marker & 0xff00) !== 0xff00) {
                    break;
                }
                else {
                    offset += view.getUint16(offset, false);
                }
            }
            return resolve(DOC_ORIENTATION.NotJpeg);
        };
        reader.readAsArrayBuffer(file);
    }
    catch (e) {
        return reject(DOC_ORIENTATION.Default);
    }
});
ImageCompress.uploadFile = (render, multiple = true) => new Promise(function (resolve, reject) {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    Promise.resolve(isSafari)
        .then((onlyNative) => {
        if (onlyNative) {
            return ImageCompress.generateUploadInputNative(window.document, multiple);
        }
        else {
            return ImageCompress.generateUploadInputRenderer(render, multiple);
        }
    })
        .then((filesList) => {
        const files = filesList ? Array.from(filesList) : [];
        const orientationPromises = files.map((file) => ImageCompress.getOrientation(file));
        const readerPromises = files.map((file) => ImageCompress.fileToDataURL(file));
        let orientationsResult = [];
        Promise.all(orientationPromises)
            .then((orientations) => {
            orientationsResult = orientations;
            return Promise.all(readerPromises);
        })
            .then((readerResult) => {
            if (multiple) {
                const result = readerResult.map((image, index) => ({
                    image,
                    orientation: orientationsResult[index],
                }));
                resolve(result);
            }
            else {
                resolve({
                    image: readerResult[0],
                    orientation: orientationsResult[0],
                });
            }
        });
    });
});
ImageCompress.fileToDataURL = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            //myReader.onloadend = (progressEvent: ProgressEvent<FileReader>)
            resolve(e.target.result);
        };
        try {
            reader.readAsDataURL(file);
        }
        catch (e) {
            reject(`ngx-image-compress - probably no file have been selected: ${e}`);
        }
    });
};
ImageCompress.generateUploadInputRenderer = (render, multiple = true) => new Promise((resolve, reject) => {
    const inputElement = render.createElement('input');
    render.setStyle(inputElement, 'display', 'none');
    render.setProperty(inputElement, 'type', 'file');
    render.setProperty(inputElement, 'accept', 'image/*');
    if (multiple) {
        render.setProperty(inputElement, 'multiple', 'true');
    }
    render.listen(inputElement, 'click', ($event) => {
        $event.target.value = '';
    });
    render.listen(inputElement, 'change', ($event) => {
        const files = $event.target.files;
        resolve(files);
    });
    inputElement.click();
});
ImageCompress.generateUploadInputNative = (documentNativeApi, multiple = true) => {
    let lock = false;
    return new Promise((resolve, reject) => {
        const inputElement = documentNativeApi.createElement('input');
        inputElement.id = 'upload-input' + new Date();
        inputElement.style.display = 'none';
        inputElement.setAttribute('type', 'file');
        if (multiple) {
            inputElement.setAttribute('multiple', 'true');
        }
        documentNativeApi.body.appendChild(inputElement);
        inputElement.addEventListener('change', () => {
            lock = true;
            resolve(inputElement.files);
            // remove from dom
            documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
        }, { once: true });
        // file blur
        window.addEventListener('focus', () => {
            setTimeout(() => {
                if (!lock && documentNativeApi.getElementById(inputElement.id)) {
                    reject(new Error('onblur'));
                    // remove from dom
                    documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
                }
            }, 300);
        }, { once: true });
        // open file select box
        inputElement.click();
    });
};
ImageCompress.compress = (imageDataUrlSource, orientation, render, ratio = 50, quality = 50, maxwidth = 0, maxheight = 0) => new Promise(function (resolve, reject) {
    quality = quality / 100;
    ratio = ratio / 100;
    const sourceImage = new Image();
    // important for safari: we need to wait for onload event
    sourceImage.onload = () => {
        const canvas = render.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            return reject(`No canvas context available`);
        }
        let w = sourceImage.naturalWidth;
        let h = sourceImage.naturalHeight;
        if (!CSS.supports('image-orientation', 'from-image')) {
            if (orientation === DOC_ORIENTATION.Right ||
                orientation === DOC_ORIENTATION.Left) {
                const t = w;
                w = h;
                h = t;
            }
        }
        let xratio = maxwidth ? maxwidth / w : 1;
        let yratio = maxheight ? maxheight / h : 1;
        ratio = Math.min(ratio, xratio, yratio);
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        const TO_RADIANS = Math.PI / 180;
        if (CSS.supports('image-orientation', 'from-image') ||
            orientation === DOC_ORIENTATION.Up) {
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        else if (orientation === DOC_ORIENTATION.Right) {
            ctx.save();
            ctx.rotate(90 * TO_RADIANS);
            ctx.translate(0, -canvas.width);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Left) {
            ctx.save();
            ctx.rotate(-90 * TO_RADIANS);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Down) {
            ctx.save();
            ctx.rotate(180 * TO_RADIANS);
            ctx.translate(-canvas.width, -canvas.height);
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
            ctx.restore();
        }
        else {
            // no orientation value found - same as default UP
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        const mime = imageDataUrlSource.substr(5, imageDataUrlSource.split(';')[0].length - 5);
        // TODO test on mime
        const result = canvas.toDataURL(mime, quality);
        resolve(result);
    };
    sourceImage.onerror = (e) => reject(e);
    sourceImage.src = imageDataUrlSource;
});
ImageCompress.byteCount = (imgString) => encodeURI(imgString).split(/%..|./).length - 1;
ImageCompress.getImageMaxSize = async (maxSizeMb, debugMode, render) => {
    const MAX_TRIES = 10;
    const bytesToMB = (bytes) => (bytes / 1024 / 1024).toFixed(2);
    if (debugMode) {
        console.debug('NgxImageCompress - Opening upload window');
    }
    let myFile = (await ImageCompress.uploadFile(render, false));
    let compressedFile;
    for (let i = 0; i < MAX_TRIES; i++) {
        const previousSize = ImageCompress.byteCount(myFile.image);
        compressedFile = await ImageCompress.compress(myFile.image, myFile.orientation, render, 50, 100);
        const newSize = ImageCompress.byteCount(compressedFile);
        console.debug('NgxImageCompress -', 'Compression from', bytesToMB(previousSize), 'MB to', bytesToMB(newSize), 'MB');
        if (newSize >= previousSize) {
            if (i === 0) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced at all - returning the original", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
            else {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced more - returning the best we can, which is ", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        else {
            if (newSize < maxSizeMb * 1024 * 1024) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', 'Here your file', bytesToMB(newSize), 'MB large');
                }
                return compressedFile;
            }
            else if (i === 9) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't reach the desired size after", MAX_TRIES, 'tries. Returning file ', bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        if (debugMode) {
            console.debug('NgxImageCompress -', 'Reached', bytesToMB(newSize), 'MB large. Trying another time after', i + 1, 'times');
        }
        myFile.image = compressedFile;
    }
    if (debugMode) {
        console.debug('NgxImageCompress - Unexpected error');
    }
    throw '';
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY29tcHJlc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaW1hZ2UtY29tcHJlc3Mvc3JjL2xpYi9pbWFnZS1jb21wcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRzNELE1BQU0sT0FBTyxhQUFhOzs7QUFDakIsNEJBQWMsR0FBRyxDQUFDLElBQVUsRUFBNEIsRUFBRSxDQUMvRCxJQUFJLE9BQU8sQ0FBa0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDL0MsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFDaEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDbkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQXFCLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDcEIsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxNQUFNLEVBQUU7Z0JBQ3ZDLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUM1QztZQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDL0IsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsT0FBTyxNQUFNLEdBQUcsTUFBTSxFQUFFO2dCQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDN0MsTUFBTSxJQUFJLENBQUMsQ0FBQztnQkFDWixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7b0JB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LFlBQVksQ0FBQyxFQUN2QixVQUFVLENBQ1gsQ0FBQztpQkFDSDtnQkFDRCxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUM7YUFDcEI7U0FDRjthQUFNO1lBQ0wsSUFBSSxPQUFPLEdBQUcsU0FBUyxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUU7Z0JBQ3JDLElBQUksU0FBUyxFQUFFO29CQUNiLE9BQU8sQ0FBQyxLQUFLLENBQ1gsb0JBQW9CLEVBQ3BCLGdCQUFnQixFQUNoQixTQUFTLENBQUMsT0FBTyxDQUFDLEVBQ2xCLFVBQVUsQ0FDWCxDQUFDO2lCQUNIO2dCQUNELE9BQU8sY0FBYyxDQUFDO2FBQ3ZCO2lCQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDbEIsSUFBSSxTQUFTLEVBQUU7b0JBQ2IsT0FBTyxDQUFDLEtBQUssQ0FDWCxvQkFBb0IsRUFDcEIseUNBQXlDLEVBQ3pDLFNBQVMsRUFDVCx3QkFBd0IsRUFDeEIsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUN2QixVQUFVLENBQ1gsQ0FBQztpQkFDSDtnQkFDRCxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUM7YUFDcEI7U0FDRjtRQUNELElBQUksU0FBUyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FDWCxvQkFBb0IsRUFDcEIsU0FBUyxFQUNULFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFDbEIscUNBQXFDLEVBQ3JDLENBQUMsR0FBRyxDQUFDLEVBQ0wsT0FBTyxDQUNSLENBQUM7U0FDSDtRQUNELE1BQU0sQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDO0tBQy9CO0lBQ0QsSUFBSSxTQUFTLEVBQUU7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7S0FDdEQ7SUFDRCxNQUFNLEVBQUUsQ0FBQztBQUNYLENBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhVXJsIH0gZnJvbSAnLi9tb2RlbHMvZGF0YS11cmwnO1xyXG5pbXBvcnQgeyBET0NfT1JJRU5UQVRJT04gfSBmcm9tICcuL21vZGVscy9ET0NfT1JJRU5UQVRJT04nO1xyXG5pbXBvcnQgeyBVcGxvYWRSZXNwb25zZSB9IGZyb20gJy4vbW9kZWxzL3VwbG9hZC1yZXNwb25zZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgSW1hZ2VDb21wcmVzcyB7XHJcbiAgc3RhdGljIGdldE9yaWVudGF0aW9uID0gKGZpbGU6IEZpbGUpOiBQcm9taXNlPERPQ19PUklFTlRBVElPTj4gPT5cclxuICAgIG5ldyBQcm9taXNlPERPQ19PUklFTlRBVElPTj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcocmVhZGVyLnJlc3VsdCBhcyBBcnJheUJ1ZmZlcik7XHJcbiAgICAgICAgICBpZiAoIXZpZXcuYnl0ZUxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShET0NfT1JJRU5UQVRJT04uTm90RGVmaW5lZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAodmlldy5nZXRVaW50MTYoMCwgZmFsc2UpICE9PSAweGZmZDgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdERlZmluZWQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5ieXRlTGVuZ3RoO1xyXG4gICAgICAgICAgbGV0IG9mZnNldCA9IDI7XHJcbiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgbGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hcmtlciA9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgZmFsc2UpO1xyXG4gICAgICAgICAgICBvZmZzZXQgKz0gMjtcclxuICAgICAgICAgICAgaWYgKG1hcmtlciA9PT0gMHhmZmUxKSB7XHJcbiAgICAgICAgICAgICAgaWYgKHZpZXcuZ2V0VWludDMyKChvZmZzZXQgKz0gMiksIGZhbHNlKSAhPT0gMHg0NTc4Njk2Nikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdEpwZWcpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBsaXR0bGUgPSB2aWV3LmdldFVpbnQxNigob2Zmc2V0ICs9IDYpLCBmYWxzZSkgPT09IDB4NDk0OTtcclxuICAgICAgICAgICAgICBvZmZzZXQgKz0gdmlldy5nZXRVaW50MzIob2Zmc2V0ICsgNCwgbGl0dGxlKTtcclxuICAgICAgICAgICAgICBjb25zdCB0YWdzID0gdmlldy5nZXRVaW50MTYob2Zmc2V0LCBsaXR0bGUpO1xyXG4gICAgICAgICAgICAgIG9mZnNldCArPSAyO1xyXG4gICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFnczsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodmlldy5nZXRVaW50MTYob2Zmc2V0ICsgaSAqIDEyLCBsaXR0bGUpID09PSAweDAxMTIpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodmlldy5nZXRVaW50MTYob2Zmc2V0ICsgaSAqIDEyICsgOCwgbGl0dGxlKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKChtYXJrZXIgJiAweGZmMDApICE9PSAweGZmMDApIHtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBvZmZzZXQgKz0gdmlldy5nZXRVaW50MTYob2Zmc2V0LCBmYWxzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3RKcGVnKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIHJldHVybiByZWplY3QoRE9DX09SSUVOVEFUSU9OLkRlZmF1bHQpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgc3RhdGljIHVwbG9hZEZpbGUgPSAoXHJcbiAgICByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgIG11bHRpcGxlOiBib29sZWFuID0gdHJ1ZVxyXG4gICk6IFByb21pc2U8VXBsb2FkUmVzcG9uc2UgfCBVcGxvYWRSZXNwb25zZVtdPiA9PlxyXG4gICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICBjb25zdCBpc1NhZmFyaSA9IC9eKCg/IWNocm9tZXxhbmRyb2lkKS4pKnNhZmFyaS9pLnRlc3QoXHJcbiAgICAgICAgbmF2aWdhdG9yLnVzZXJBZ2VudFxyXG4gICAgICApO1xyXG5cclxuICAgICAgUHJvbWlzZS5yZXNvbHZlKGlzU2FmYXJpKVxyXG4gICAgICAgIC50aGVuKChvbmx5TmF0aXZlKSA9PiB7XHJcbiAgICAgICAgICBpZiAob25seU5hdGl2ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gSW1hZ2VDb21wcmVzcy5nZW5lcmF0ZVVwbG9hZElucHV0TmF0aXZlKFxyXG4gICAgICAgICAgICAgIHdpbmRvdy5kb2N1bWVudCxcclxuICAgICAgICAgICAgICBtdWx0aXBsZVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIEltYWdlQ29tcHJlc3MuZ2VuZXJhdGVVcGxvYWRJbnB1dFJlbmRlcmVyKHJlbmRlciwgbXVsdGlwbGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnRoZW4oKGZpbGVzTGlzdDogRmlsZUxpc3QgfCBudWxsKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmaWxlcyA9IGZpbGVzTGlzdCA/IEFycmF5LmZyb20oZmlsZXNMaXN0KSA6IFtdO1xyXG4gICAgICAgICAgY29uc3Qgb3JpZW50YXRpb25Qcm9taXNlcyA9IGZpbGVzLm1hcCgoZmlsZSkgPT5cclxuICAgICAgICAgICAgSW1hZ2VDb21wcmVzcy5nZXRPcmllbnRhdGlvbihmaWxlKVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIGNvbnN0IHJlYWRlclByb21pc2VzID0gZmlsZXMubWFwKChmaWxlKSA9PlxyXG4gICAgICAgICAgICBJbWFnZUNvbXByZXNzLmZpbGVUb0RhdGFVUkwoZmlsZSlcclxuICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgbGV0IG9yaWVudGF0aW9uc1Jlc3VsdDogRE9DX09SSUVOVEFUSU9OW10gPSBbXTtcclxuXHJcbiAgICAgICAgICBQcm9taXNlLmFsbChvcmllbnRhdGlvblByb21pc2VzKVxyXG4gICAgICAgICAgICAudGhlbigob3JpZW50YXRpb25zOiBET0NfT1JJRU5UQVRJT05bXSkgPT4ge1xyXG4gICAgICAgICAgICAgIG9yaWVudGF0aW9uc1Jlc3VsdCA9IG9yaWVudGF0aW9ucztcclxuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVhZGVyUHJvbWlzZXMpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbigocmVhZGVyUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSByZWFkZXJSZXN1bHQubWFwKChpbWFnZSwgaW5kZXgpID0+ICh7XHJcbiAgICAgICAgICAgICAgICAgIGltYWdlLFxyXG4gICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb25zUmVzdWx0W2luZGV4XSxcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7XHJcbiAgICAgICAgICAgICAgICAgIGltYWdlOiByZWFkZXJSZXN1bHRbMF0sXHJcbiAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbnNSZXN1bHRbMF0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gIHN0YXRpYyBmaWxlVG9EYXRhVVJMID0gKGZpbGU6IEZpbGUpOiBQcm9taXNlPHN0cmluZz4gPT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICByZWFkZXIub25sb2FkID0gKGU6IGFueSkgPT4ge1xyXG4gICAgICAgIC8vbXlSZWFkZXIub25sb2FkZW5kID0gKHByb2dyZXNzRXZlbnQ6IFByb2dyZXNzRXZlbnQ8RmlsZVJlYWRlcj4pXHJcbiAgICAgICAgcmVzb2x2ZShlLnRhcmdldC5yZXN1bHQpO1xyXG4gICAgICB9O1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgYG5neC1pbWFnZS1jb21wcmVzcyAtIHByb2JhYmx5IG5vIGZpbGUgaGF2ZSBiZWVuIHNlbGVjdGVkOiAke2V9YFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIHN0YXRpYyBnZW5lcmF0ZVVwbG9hZElucHV0UmVuZGVyZXIgPSAoXHJcbiAgICByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgIG11bHRpcGxlOiBib29sZWFuID0gdHJ1ZVxyXG4gICkgPT5cclxuICAgIG5ldyBQcm9taXNlPEZpbGVMaXN0IHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSByZW5kZXIuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcclxuICAgICAgcmVuZGVyLnNldFN0eWxlKGlucHV0RWxlbWVudCwgJ2Rpc3BsYXknLCAnbm9uZScpO1xyXG4gICAgICByZW5kZXIuc2V0UHJvcGVydHkoaW5wdXRFbGVtZW50LCAndHlwZScsICdmaWxlJyk7XHJcbiAgICAgIHJlbmRlci5zZXRQcm9wZXJ0eShpbnB1dEVsZW1lbnQsICdhY2NlcHQnLCAnaW1hZ2UvKicpO1xyXG5cclxuICAgICAgaWYgKG11bHRpcGxlKSB7XHJcbiAgICAgICAgcmVuZGVyLnNldFByb3BlcnR5KGlucHV0RWxlbWVudCwgJ211bHRpcGxlJywgJ3RydWUnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVuZGVyLmxpc3RlbihpbnB1dEVsZW1lbnQsICdjbGljaycsICgkZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAoJGV2ZW50LnRhcmdldCBhcyBhbnkgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUgPSAnJztcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZW5kZXIubGlzdGVuKGlucHV0RWxlbWVudCwgJ2NoYW5nZScsICgkZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBmaWxlczogRmlsZUxpc3QgPSAkZXZlbnQudGFyZ2V0LmZpbGVzO1xyXG4gICAgICAgIHJlc29sdmUoZmlsZXMpO1xyXG4gICAgICB9KTtcclxuICAgICAgaW5wdXRFbGVtZW50LmNsaWNrKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgc3RhdGljIGdlbmVyYXRlVXBsb2FkSW5wdXROYXRpdmUgPSAoXHJcbiAgICBkb2N1bWVudE5hdGl2ZUFwaTogYW55LFxyXG4gICAgbXVsdGlwbGU6IGJvb2xlYW4gPSB0cnVlXHJcbiAgKSA9PiB7XHJcbiAgICBsZXQgbG9jayA9IGZhbHNlO1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEZpbGVMaXN0IHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSBkb2N1bWVudE5hdGl2ZUFwaS5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xyXG4gICAgICBpbnB1dEVsZW1lbnQuaWQgPSAndXBsb2FkLWlucHV0JyArIG5ldyBEYXRlKCk7XHJcbiAgICAgIGlucHV0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICBpbnB1dEVsZW1lbnQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2ZpbGUnKTtcclxuXHJcbiAgICAgIGlmIChtdWx0aXBsZSkge1xyXG4gICAgICAgIGlucHV0RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ211bHRpcGxlJywgJ3RydWUnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZG9jdW1lbnROYXRpdmVBcGkuYm9keS5hcHBlbmRDaGlsZChpbnB1dEVsZW1lbnQpO1xyXG5cclxuICAgICAgaW5wdXRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXHJcbiAgICAgICAgJ2NoYW5nZScsXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgbG9jayA9IHRydWU7XHJcbiAgICAgICAgICByZXNvbHZlKGlucHV0RWxlbWVudC5maWxlcyk7XHJcbiAgICAgICAgICAvLyByZW1vdmUgZnJvbSBkb21cclxuICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkucmVtb3ZlQ2hpbGQoXHJcbiAgICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmdldEVsZW1lbnRCeUlkKGlucHV0RWxlbWVudC5pZCkgYXMgTm9kZVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgb25jZTogdHJ1ZSB9XHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBmaWxlIGJsdXJcclxuICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXHJcbiAgICAgICAgJ2ZvY3VzJyxcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFsb2NrICYmIGRvY3VtZW50TmF0aXZlQXBpLmdldEVsZW1lbnRCeUlkKGlucHV0RWxlbWVudC5pZCkpIHtcclxuICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdvbmJsdXInKSk7XHJcbiAgICAgICAgICAgICAgLy8gcmVtb3ZlIGZyb20gZG9tXHJcbiAgICAgICAgICAgICAgZG9jdW1lbnROYXRpdmVBcGkuYm9keS5yZW1vdmVDaGlsZChcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmdldEVsZW1lbnRCeUlkKGlucHV0RWxlbWVudC5pZCkgYXMgTm9kZVxyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0sIDMwMCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB7IG9uY2U6IHRydWUgfVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gb3BlbiBmaWxlIHNlbGVjdCBib3hcclxuICAgICAgaW5wdXRFbGVtZW50LmNsaWNrKCk7XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICBzdGF0aWMgY29tcHJlc3MgPSAoXHJcbiAgICBpbWFnZURhdGFVcmxTb3VyY2U6IERhdGFVcmwsXHJcbiAgICBvcmllbnRhdGlvbjogRE9DX09SSUVOVEFUSU9OLFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICByYXRpbzogbnVtYmVyID0gNTAsXHJcbiAgICBxdWFsaXR5OiBudW1iZXIgPSA1MCxcclxuICAgIG1heHdpZHRoOiBudW1iZXIgPSAwLFxyXG4gICAgbWF4aGVpZ2h0OiBudW1iZXIgPSAwXHJcbiAgKTogUHJvbWlzZTxzdHJpbmc+ID0+XHJcbiAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgIHF1YWxpdHkgPSBxdWFsaXR5IC8gMTAwO1xyXG4gICAgICByYXRpbyA9IHJhdGlvIC8gMTAwO1xyXG4gICAgICBjb25zdCBzb3VyY2VJbWFnZSA9IG5ldyBJbWFnZSgpO1xyXG5cclxuICAgICAgLy8gaW1wb3J0YW50IGZvciBzYWZhcmk6IHdlIG5lZWQgdG8gd2FpdCBmb3Igb25sb2FkIGV2ZW50XHJcbiAgICAgIHNvdXJjZUltYWdlLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gcmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgICAgIGNvbnN0IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEIHwgbnVsbCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xyXG5cclxuICAgICAgICBpZiAoIWN0eCkge1xyXG4gICAgICAgICAgcmV0dXJuIHJlamVjdChgTm8gY2FudmFzIGNvbnRleHQgYXZhaWxhYmxlYCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdyA9IHNvdXJjZUltYWdlLm5hdHVyYWxXaWR0aDtcclxuICAgICAgICBsZXQgaCA9IHNvdXJjZUltYWdlLm5hdHVyYWxIZWlnaHQ7XHJcblxyXG4gICAgICAgIGlmICghQ1NTLnN1cHBvcnRzKCdpbWFnZS1vcmllbnRhdGlvbicsICdmcm9tLWltYWdlJykpIHtcclxuICAgICAgICAgIGlmIChcclxuICAgICAgICAgICAgb3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5SaWdodCB8fFxyXG4gICAgICAgICAgICBvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLkxlZnRcclxuICAgICAgICAgICkge1xyXG4gICAgICAgICAgICBjb25zdCB0ID0gdztcclxuICAgICAgICAgICAgdyA9IGg7XHJcbiAgICAgICAgICAgIGggPSB0O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHhyYXRpbyA9IG1heHdpZHRoID8gbWF4d2lkdGggLyB3IDogMTtcclxuICAgICAgICBsZXQgeXJhdGlvID0gbWF4aGVpZ2h0ID8gbWF4aGVpZ2h0IC8gaCA6IDE7XHJcbiAgICAgICAgcmF0aW8gPSBNYXRoLm1pbihyYXRpbywgeHJhdGlvLCB5cmF0aW8pO1xyXG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHcgKiByYXRpbztcclxuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaCAqIHJhdGlvO1xyXG5cclxuICAgICAgICBjb25zdCBUT19SQURJQU5TID0gTWF0aC5QSSAvIDE4MDtcclxuXHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgQ1NTLnN1cHBvcnRzKCdpbWFnZS1vcmllbnRhdGlvbicsICdmcm9tLWltYWdlJykgfHxcclxuICAgICAgICAgIG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uVXBcclxuICAgICAgICApIHtcclxuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLlJpZ2h0KSB7XHJcbiAgICAgICAgICBjdHguc2F2ZSgpO1xyXG4gICAgICAgICAgY3R4LnJvdGF0ZSg5MCAqIFRPX1JBRElBTlMpO1xyXG4gICAgICAgICAgY3R4LnRyYW5zbGF0ZSgwLCAtY2FudmFzLndpZHRoKTtcclxuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy5oZWlnaHQsIGNhbnZhcy53aWR0aCk7XHJcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5MZWZ0KSB7XHJcbiAgICAgICAgICBjdHguc2F2ZSgpO1xyXG4gICAgICAgICAgY3R4LnJvdGF0ZSgtOTAgKiBUT19SQURJQU5TKTtcclxuICAgICAgICAgIGN0eC50cmFuc2xhdGUoLWNhbnZhcy53aWR0aCwgMCk7XHJcbiAgICAgICAgICBjdHguZHJhd0ltYWdlKHNvdXJjZUltYWdlLCAwLCAwLCBjYW52YXMuaGVpZ2h0LCBjYW52YXMud2lkdGgpO1xyXG4gICAgICAgICAgY3R4LnJlc3RvcmUoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uRG93bikge1xyXG4gICAgICAgICAgY3R4LnNhdmUoKTtcclxuICAgICAgICAgIGN0eC5yb3RhdGUoMTgwICogVE9fUkFESUFOUyk7XHJcbiAgICAgICAgICBjdHgudHJhbnNsYXRlKC1jYW52YXMud2lkdGgsIC1jYW52YXMuaGVpZ2h0KTtcclxuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XHJcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBubyBvcmllbnRhdGlvbiB2YWx1ZSBmb3VuZCAtIHNhbWUgYXMgZGVmYXVsdCBVUFxyXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG1pbWUgPSBpbWFnZURhdGFVcmxTb3VyY2Uuc3Vic3RyKFxyXG4gICAgICAgICAgNSxcclxuICAgICAgICAgIGltYWdlRGF0YVVybFNvdXJjZS5zcGxpdCgnOycpWzBdLmxlbmd0aCAtIDVcclxuICAgICAgICApO1xyXG4gICAgICAgIC8vIFRPRE8gdGVzdCBvbiBtaW1lXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FudmFzLnRvRGF0YVVSTChtaW1lLCBxdWFsaXR5KTtcclxuXHJcbiAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgc291cmNlSW1hZ2Uub25lcnJvciA9IChlKSA9PiByZWplY3QoZSk7XHJcbiAgICAgIHNvdXJjZUltYWdlLnNyYyA9IGltYWdlRGF0YVVybFNvdXJjZTtcclxuICAgIH0pO1xyXG5cclxuICBzdGF0aWMgYnl0ZUNvdW50ID0gKGltZ1N0cmluZzogRGF0YVVybCk6IG51bWJlciA9PlxyXG4gICAgZW5jb2RlVVJJKGltZ1N0cmluZykuc3BsaXQoLyUuLnwuLykubGVuZ3RoIC0gMTtcclxuXHJcbiAgc3RhdGljIGdldEltYWdlTWF4U2l6ZSA9IGFzeW5jIChcclxuICAgIG1heFNpemVNYjogbnVtYmVyLFxyXG4gICAgZGVidWdNb2RlOiBib29sZWFuLFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjJcclxuICApOiBQcm9taXNlPERhdGFVcmw+ID0+IHtcclxuICAgIGNvbnN0IE1BWF9UUklFUyA9IDEwO1xyXG5cclxuICAgIGNvbnN0IGJ5dGVzVG9NQiA9IChieXRlczogbnVtYmVyKSA9PiAoYnl0ZXMgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKTtcclxuXHJcbiAgICBpZiAoZGVidWdNb2RlKSB7XHJcbiAgICAgIGNvbnNvbGUuZGVidWcoJ05neEltYWdlQ29tcHJlc3MgLSBPcGVuaW5nIHVwbG9hZCB3aW5kb3cnKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgbXlGaWxlOiBVcGxvYWRSZXNwb25zZSA9IChhd2FpdCBJbWFnZUNvbXByZXNzLnVwbG9hZEZpbGUoXHJcbiAgICAgIHJlbmRlcixcclxuICAgICAgZmFsc2VcclxuICAgICkpIGFzIFVwbG9hZFJlc3BvbnNlO1xyXG5cclxuICAgIGxldCBjb21wcmVzc2VkRmlsZTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1BWF9UUklFUzsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IHByZXZpb3VzU2l6ZSA9IEltYWdlQ29tcHJlc3MuYnl0ZUNvdW50KG15RmlsZS5pbWFnZSk7XHJcbiAgICAgIGNvbXByZXNzZWRGaWxlID0gYXdhaXQgSW1hZ2VDb21wcmVzcy5jb21wcmVzcyhcclxuICAgICAgICBteUZpbGUuaW1hZ2UsXHJcbiAgICAgICAgbXlGaWxlLm9yaWVudGF0aW9uLFxyXG4gICAgICAgIHJlbmRlcixcclxuICAgICAgICA1MCxcclxuICAgICAgICAxMDBcclxuICAgICAgKTtcclxuICAgICAgY29uc3QgbmV3U2l6ZSA9IEltYWdlQ29tcHJlc3MuYnl0ZUNvdW50KGNvbXByZXNzZWRGaWxlKTtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhcclxuICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcclxuICAgICAgICAnQ29tcHJlc3Npb24gZnJvbScsXHJcbiAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXHJcbiAgICAgICAgJ01CIHRvJyxcclxuICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgJ01CJ1xyXG4gICAgICApO1xyXG4gICAgICBpZiAobmV3U2l6ZSA+PSBwcmV2aW91c1NpemUpIHtcclxuICAgICAgICBpZiAoaSA9PT0gMCkge1xyXG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgICAgICdOZ3hJbWFnZUNvbXByZXNzIC0nLFxyXG4gICAgICAgICAgICAgIFwiRmlsZSBjYW4ndCBiZSByZWR1Y2VkIGF0IGFsbCAtIHJldHVybmluZyB0aGUgb3JpZ2luYWxcIixcclxuICAgICAgICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcclxuICAgICAgICAgICAgICAnTUIgbGFyZ2UnXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aHJvdyBteUZpbGUuaW1hZ2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcclxuICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcclxuICAgICAgICAgICAgICBcIkZpbGUgY2FuJ3QgYmUgcmVkdWNlZCBtb3JlIC0gcmV0dXJuaW5nIHRoZSBiZXN0IHdlIGNhbiwgd2hpY2ggaXMgXCIsXHJcbiAgICAgICAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXHJcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdGhyb3cgbXlGaWxlLmltYWdlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAobmV3U2l6ZSA8IG1heFNpemVNYiAqIDEwMjQgKiAxMDI0KSB7XHJcbiAgICAgICAgICBpZiAoZGVidWdNb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXHJcbiAgICAgICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXHJcbiAgICAgICAgICAgICAgJ0hlcmUgeW91ciBmaWxlJyxcclxuICAgICAgICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNvbXByZXNzZWRGaWxlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaSA9PT0gOSkge1xyXG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgICAgICdOZ3hJbWFnZUNvbXByZXNzIC0nLFxyXG4gICAgICAgICAgICAgIFwiRmlsZSBjYW4ndCByZWFjaCB0aGUgZGVzaXJlZCBzaXplIGFmdGVyXCIsXHJcbiAgICAgICAgICAgICAgTUFYX1RSSUVTLFxyXG4gICAgICAgICAgICAgICd0cmllcy4gUmV0dXJuaW5nIGZpbGUgJyxcclxuICAgICAgICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcclxuICAgICAgICAgICAgICAnTUIgbGFyZ2UnXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aHJvdyBteUZpbGUuaW1hZ2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXHJcbiAgICAgICAgICAnUmVhY2hlZCcsXHJcbiAgICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgICAnTUIgbGFyZ2UuIFRyeWluZyBhbm90aGVyIHRpbWUgYWZ0ZXInLFxyXG4gICAgICAgICAgaSArIDEsXHJcbiAgICAgICAgICAndGltZXMnXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICBteUZpbGUuaW1hZ2UgPSBjb21wcmVzc2VkRmlsZTtcclxuICAgIH1cclxuICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZygnTmd4SW1hZ2VDb21wcmVzcyAtIFVuZXhwZWN0ZWQgZXJyb3InKTtcclxuICAgIH1cclxuICAgIHRocm93ICcnO1xyXG4gIH07XHJcbn1cclxuIl19