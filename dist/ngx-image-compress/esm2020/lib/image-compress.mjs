var _a;
import { DOC_ORIENTATION } from './models/DOC_ORIENTATION';
export class ImageCompress {
}
_a = ImageCompress;
ImageCompress.getOrientation = (file) => new Promise((resolve, reject) => {
    try {
        const reader = new FileReader();
        reader.onload = () => {
            const view = new DataView(reader.result);
            if (!view.byteLength) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            if (view.getUint16(0, false) !== 0xffd8) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            const length = view.byteLength;
            let offset = 2;
            while (offset < length) {
                const marker = view.getUint16(offset, false);
                offset += 2;
                if (marker === 0xffe1) {
                    if (view.getUint32((offset += 2), false) !== 0x45786966) {
                        return resolve(DOC_ORIENTATION.NotJpeg);
                    }
                    const little = view.getUint16((offset += 6), false) === 0x4949;
                    offset += view.getUint32(offset + 4, little);
                    const tags = view.getUint16(offset, little);
                    offset += 2;
                    for (let i = 0; i < tags; i++) {
                        if (view.getUint16(offset + i * 12, little) === 0x0112) {
                            return resolve(view.getUint16(offset + i * 12 + 8, little));
                        }
                    }
                }
                else if ((marker & 0xff00) !== 0xff00) {
                    break;
                }
                else {
                    offset += view.getUint16(offset, false);
                }
            }
            return resolve(DOC_ORIENTATION.NotJpeg);
        };
        reader.readAsArrayBuffer(file);
    }
    catch (e) {
        return reject(DOC_ORIENTATION.Default);
    }
});
ImageCompress.uploadFile = (render, multiple = true) => new Promise(function (resolve, reject) {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    Promise.resolve(isSafari)
        .then((onlyNative) => {
        if (onlyNative) {
            return ImageCompress.generateUploadInputNative(window.document, multiple);
        }
        else {
            return ImageCompress.generateUploadInputRenderer(render, multiple);
        }
    })
        .then((filesList) => {
        const files = filesList ? Array.from(filesList) : [];
        const orientationPromises = files.map((file) => ImageCompress.getOrientation(file));
        const readerPromises = files.map((file) => ImageCompress.fileToDataURL(file));
        let orientationsResult = [];
        Promise.all(orientationPromises)
            .then((orientations) => {
            orientationsResult = orientations;
            return Promise.all(readerPromises);
        })
            .then((readerResult) => {
            if (multiple) {
                const result = readerResult.map((image, index) => ({
                    image,
                    orientation: orientationsResult[index],
                }));
                resolve(result);
            }
            else {
                resolve({
                    image: readerResult[0],
                    orientation: orientationsResult[0],
                });
            }
        });
    });
});
ImageCompress.fileToDataURL = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            //myReader.onloadend = (progressEvent: ProgressEvent<FileReader>)
            resolve(e.target.result);
        };
        try {
            reader.readAsDataURL(file);
        }
        catch (e) {
            reject(`ngx-image-compress - probably no file have been selected: ${e}`);
        }
    });
};
ImageCompress.generateUploadInputRenderer = (render, multiple = true) => new Promise((resolve, reject) => {
    const inputElement = render.createElement('input');
    render.setStyle(inputElement, 'display', 'none');
    render.setProperty(inputElement, 'type', 'file');
    render.setProperty(inputElement, 'accept', 'image/*');
    if (multiple) {
        render.setProperty(inputElement, 'multiple', 'true');
    }
    render.listen(inputElement, 'click', ($event) => {
        $event.target.value = '';
    });
    render.listen(inputElement, 'change', ($event) => {
        const files = $event.target.files;
        resolve(files);
    });
    inputElement.click();
});
ImageCompress.generateUploadInputNative = (documentNativeApi, multiple = true) => {
    let lock = false;
    return new Promise((resolve, reject) => {
        const inputElement = documentNativeApi.createElement('input');
        inputElement.id = 'upload-input' + new Date();
        inputElement.style.display = 'none';
        inputElement.setAttribute('type', 'file');
        if (multiple) {
            inputElement.setAttribute('multiple', 'true');
        }
        documentNativeApi.body.appendChild(inputElement);
        inputElement.addEventListener('change', () => {
            lock = true;
            resolve(inputElement.files);
            // remove from dom
            documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
        }, { once: true });
        // file blur
        window.addEventListener('focus', () => {
            setTimeout(() => {
                if (!lock && documentNativeApi.getElementById(inputElement.id)) {
                    reject(new Error('onblur'));
                    // remove from dom
                    documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
                }
            }, 300);
        }, { once: true });
        // open file select box
        inputElement.click();
    });
};
ImageCompress.compress = (imageDataUrlSource, orientation, render, ratio = 50, quality = 50, maxwidth = 0, maxheight = 0, mime = "") => new Promise(function (resolve, reject) {
    quality = quality / 100;
    ratio = ratio / 100;
    const sourceImage = new Image();
    // important for safari: we need to wait for onload event
    sourceImage.onload = () => {
        const canvas = render.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            return reject(`No canvas context available`);
        }
        let w = sourceImage.naturalWidth;
        let h = sourceImage.naturalHeight;
        if (!CSS.supports('image-orientation', 'from-image')) {
            if (orientation === DOC_ORIENTATION.Right ||
                orientation === DOC_ORIENTATION.Left) {
                const t = w;
                w = h;
                h = t;
            }
        }
        let xratio = maxwidth ? maxwidth / w : 1;
        let yratio = maxheight ? maxheight / h : 1;
        ratio = Math.min(ratio, xratio, yratio);
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        const TO_RADIANS = Math.PI / 180;
        if (CSS.supports('image-orientation', 'from-image') ||
            orientation === DOC_ORIENTATION.Up) {
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        else if (orientation === DOC_ORIENTATION.Right) {
            ctx.save();
            ctx.rotate(90 * TO_RADIANS);
            ctx.translate(0, -canvas.width);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Left) {
            ctx.save();
            ctx.rotate(-90 * TO_RADIANS);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Down) {
            ctx.save();
            ctx.rotate(180 * TO_RADIANS);
            ctx.translate(-canvas.width, -canvas.height);
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
            ctx.restore();
        }
        else {
            // no orientation value found - same as default UP
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        if (mime == "") {
            mime = imageDataUrlSource.substr(5, imageDataUrlSource.split(';')[0].length - 5);
        }
        // TODO test on mime
        const result = canvas.toDataURL(mime, quality);
        resolve(result);
    };
    sourceImage.onerror = (e) => reject(e);
    sourceImage.src = imageDataUrlSource;
});
ImageCompress.byteCount = (imgString) => encodeURI(imgString).split(/%..|./).length - 1;
ImageCompress.getImageMaxSize = async (maxSizeMb, debugMode, render) => {
    const MAX_TRIES = 10;
    const bytesToMB = (bytes) => (bytes / 1024 / 1024).toFixed(2);
    if (debugMode) {
        console.debug('NgxImageCompress - Opening upload window');
    }
    let myFile = (await ImageCompress.uploadFile(render, false));
    let compressedFile;
    for (let i = 0; i < MAX_TRIES; i++) {
        const previousSize = ImageCompress.byteCount(myFile.image);
        compressedFile = await ImageCompress.compress(myFile.image, myFile.orientation, render, 50, 100);
        const newSize = ImageCompress.byteCount(compressedFile);
        console.debug('NgxImageCompress -', 'Compression from', bytesToMB(previousSize), 'MB to', bytesToMB(newSize), 'MB');
        if (newSize >= previousSize) {
            if (i === 0) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced at all - returning the original", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
            else {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced more - returning the best we can, which is ", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        else {
            if (newSize < maxSizeMb * 1024 * 1024) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', 'Here your file', bytesToMB(newSize), 'MB large');
                }
                return compressedFile;
            }
            else if (i === 9) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't reach the desired size after", MAX_TRIES, 'tries. Returning file ', bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        if (debugMode) {
            console.debug('NgxImageCompress -', 'Reached', bytesToMB(newSize), 'MB large. Trying another time after', i + 1, 'times');
        }
        myFile.image = compressedFile;
    }
    if (debugMode) {
        console.debug('NgxImageCompress - Unexpected error');
    }
    throw '';
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY29tcHJlc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaW1hZ2UtY29tcHJlc3Mvc3JjL2xpYi9pbWFnZS1jb21wcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRzNELE1BQU0sT0FBTyxhQUFhOzs7QUFDakIsNEJBQWMsR0FBRyxDQUFDLElBQVUsRUFBNEIsRUFBRSxDQUMvRCxJQUFJLE9BQU8sQ0FBa0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDL0MsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFDaEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDbkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQXFCLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDcEIsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxNQUFNLEVBQUU7Z0JBQ3ZDLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUM1QztZQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDL0IsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsT0FBTyxNQUFNLEdBQUcsTUFBTSxFQUFFO2dCQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDN0MsTUFBTSxJQUFJLENBQUMsQ0FBQztnQkFDWixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7b0JB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clxuaW1wb3J0IHsgRGF0YVVybCB9IGZyb20gJy4vbW9kZWxzL2RhdGEtdXJsJztcclxuaW1wb3J0IHsgRE9DX09SSUVOVEFUSU9OIH0gZnJvbSAnLi9tb2RlbHMvRE9DX09SSUVOVEFUSU9OJztcclxuaW1wb3J0IHsgVXBsb2FkUmVzcG9uc2UgfSBmcm9tICcuL21vZGVscy91cGxvYWQtcmVzcG9uc2UnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEltYWdlQ29tcHJlc3Mge1xyXG4gIHN0YXRpYyBnZXRPcmllbnRhdGlvbiA9IChmaWxlOiBGaWxlKTogUHJvbWlzZTxET0NfT1JJRU5UQVRJT04+ID0+XHJcbiAgICBuZXcgUHJvbWlzZTxET0NfT1JJRU5UQVRJT04+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHJlYWRlci5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xyXG4gICAgICAgICAgaWYgKCF2aWV3LmJ5dGVMZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdERlZmluZWQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHZpZXcuZ2V0VWludDE2KDAsIGZhbHNlKSAhPT0gMHhmZmQ4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3REZWZpbmVkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcuYnl0ZUxlbmd0aDtcclxuICAgICAgICAgIGxldCBvZmZzZXQgPSAyO1xyXG4gICAgICAgICAgd2hpbGUgKG9mZnNldCA8IGxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCBtYXJrZXIgPSB2aWV3LmdldFVpbnQxNihvZmZzZXQsIGZhbHNlKTtcclxuICAgICAgICAgICAgb2Zmc2V0ICs9IDI7XHJcbiAgICAgICAgICAgIGlmIChtYXJrZXIgPT09IDB4ZmZlMSkge1xyXG4gICAgICAgICAgICAgIGlmICh2aWV3LmdldFVpbnQzMigob2Zmc2V0ICs9IDIpLCBmYWxzZSkgIT09IDB4NDU3ODY5NjYpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3RKcGVnKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgbGl0dGxlID0gdmlldy5nZXRVaW50MTYoKG9mZnNldCArPSA2KSwgZmFsc2UpID09PSAweDQ5NDk7XHJcbiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHZpZXcuZ2V0VWludDMyKG9mZnNldCArIDQsIGxpdHRsZSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgdGFncyA9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgbGl0dGxlKTtcclxuICAgICAgICAgICAgICBvZmZzZXQgKz0gMjtcclxuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZ3M7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHZpZXcuZ2V0VWludDE2KG9mZnNldCArIGkgKiAxMiwgbGl0dGxlKSA9PT0gMHgwMTEyKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHZpZXcuZ2V0VWludDE2KG9mZnNldCArIGkgKiAxMiArIDgsIGxpdHRsZSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmICgobWFya2VyICYgMHhmZjAwKSAhPT0gMHhmZjAwKSB7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShET0NfT1JJRU5UQVRJT04uTm90SnBlZyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KERPQ19PUklFTlRBVElPTi5EZWZhdWx0KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gIHN0YXRpYyB1cGxvYWRGaWxlID0gKFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICBtdWx0aXBsZTogYm9vbGVhbiA9IHRydWVcclxuICApOiBQcm9taXNlPFVwbG9hZFJlc3BvbnNlIHwgVXBsb2FkUmVzcG9uc2VbXT4gPT5cclxuICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgY29uc3QgaXNTYWZhcmkgPSAvXigoPyFjaHJvbWV8YW5kcm9pZCkuKSpzYWZhcmkvaS50ZXN0KFxyXG4gICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnRcclxuICAgICAgKTtcclxuXHJcbiAgICAgIFByb21pc2UucmVzb2x2ZShpc1NhZmFyaSlcclxuICAgICAgICAudGhlbigob25seU5hdGl2ZSkgPT4ge1xyXG4gICAgICAgICAgaWYgKG9ubHlOYXRpdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIEltYWdlQ29tcHJlc3MuZ2VuZXJhdGVVcGxvYWRJbnB1dE5hdGl2ZShcclxuICAgICAgICAgICAgICB3aW5kb3cuZG9jdW1lbnQsXHJcbiAgICAgICAgICAgICAgbXVsdGlwbGVcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBJbWFnZUNvbXByZXNzLmdlbmVyYXRlVXBsb2FkSW5wdXRSZW5kZXJlcihyZW5kZXIsIG11bHRpcGxlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC50aGVuKChmaWxlc0xpc3Q6IEZpbGVMaXN0IHwgbnVsbCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZmlsZXMgPSBmaWxlc0xpc3QgPyBBcnJheS5mcm9tKGZpbGVzTGlzdCkgOiBbXTtcclxuICAgICAgICAgIGNvbnN0IG9yaWVudGF0aW9uUHJvbWlzZXMgPSBmaWxlcy5tYXAoKGZpbGUpID0+XHJcbiAgICAgICAgICAgIEltYWdlQ29tcHJlc3MuZ2V0T3JpZW50YXRpb24oZmlsZSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICBjb25zdCByZWFkZXJQcm9taXNlcyA9IGZpbGVzLm1hcCgoZmlsZSkgPT5cclxuICAgICAgICAgICAgSW1hZ2VDb21wcmVzcy5maWxlVG9EYXRhVVJMKGZpbGUpXHJcbiAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgIGxldCBvcmllbnRhdGlvbnNSZXN1bHQ6IERPQ19PUklFTlRBVElPTltdID0gW107XHJcblxyXG4gICAgICAgICAgUHJvbWlzZS5hbGwob3JpZW50YXRpb25Qcm9taXNlcylcclxuICAgICAgICAgICAgLnRoZW4oKG9yaWVudGF0aW9uczogRE9DX09SSUVOVEFUSU9OW10pID0+IHtcclxuICAgICAgICAgICAgICBvcmllbnRhdGlvbnNSZXN1bHQgPSBvcmllbnRhdGlvbnM7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHJlYWRlclByb21pc2VzKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnRoZW4oKHJlYWRlclJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZGVyUmVzdWx0Lm1hcCgoaW1hZ2UsIGluZGV4KSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICBpbWFnZSxcclxuICAgICAgICAgICAgICAgICAgb3JpZW50YXRpb246IG9yaWVudGF0aW9uc1Jlc3VsdFtpbmRleF0sXHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICBpbWFnZTogcmVhZGVyUmVzdWx0WzBdLFxyXG4gICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb25zUmVzdWx0WzBdLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICBzdGF0aWMgZmlsZVRvRGF0YVVSTCA9IChmaWxlOiBGaWxlKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgcmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcclxuICAgICAgICAvL215UmVhZGVyLm9ubG9hZGVuZCA9IChwcm9ncmVzc0V2ZW50OiBQcm9ncmVzc0V2ZW50PEZpbGVSZWFkZXI+KVxyXG4gICAgICAgIHJlc29sdmUoZS50YXJnZXQucmVzdWx0KTtcclxuICAgICAgfTtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIHJlamVjdChcclxuICAgICAgICAgIGBuZ3gtaW1hZ2UtY29tcHJlc3MgLSBwcm9iYWJseSBubyBmaWxlIGhhdmUgYmVlbiBzZWxlY3RlZDogJHtlfWBcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICBzdGF0aWMgZ2VuZXJhdGVVcGxvYWRJbnB1dFJlbmRlcmVyID0gKFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICBtdWx0aXBsZTogYm9vbGVhbiA9IHRydWVcclxuICApID0+XHJcbiAgICBuZXcgUHJvbWlzZTxGaWxlTGlzdCB8IG51bGw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgaW5wdXRFbGVtZW50ID0gcmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XHJcbiAgICAgIHJlbmRlci5zZXRTdHlsZShpbnB1dEVsZW1lbnQsICdkaXNwbGF5JywgJ25vbmUnKTtcclxuICAgICAgcmVuZGVyLnNldFByb3BlcnR5KGlucHV0RWxlbWVudCwgJ3R5cGUnLCAnZmlsZScpO1xyXG4gICAgICByZW5kZXIuc2V0UHJvcGVydHkoaW5wdXRFbGVtZW50LCAnYWNjZXB0JywgJ2ltYWdlLyonKTtcclxuXHJcbiAgICAgIGlmIChtdWx0aXBsZSkge1xyXG4gICAgICAgIHJlbmRlci5zZXRQcm9wZXJ0eShpbnB1dEVsZW1lbnQsICdtdWx0aXBsZScsICd0cnVlJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJlbmRlci5saXN0ZW4oaW5wdXRFbGVtZW50LCAnY2xpY2snLCAoJGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgKCRldmVudC50YXJnZXQgYXMgYW55IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlID0gJyc7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcmVuZGVyLmxpc3RlbihpbnB1dEVsZW1lbnQsICdjaGFuZ2UnLCAoJGV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZmlsZXM6IEZpbGVMaXN0ID0gJGV2ZW50LnRhcmdldC5maWxlcztcclxuICAgICAgICByZXNvbHZlKGZpbGVzKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGlucHV0RWxlbWVudC5jbGljaygpO1xyXG4gICAgfSk7XHJcblxyXG4gIHN0YXRpYyBnZW5lcmF0ZVVwbG9hZElucHV0TmF0aXZlID0gKFxyXG4gICAgZG9jdW1lbnROYXRpdmVBcGk6IGFueSxcclxuICAgIG11bHRpcGxlOiBib29sZWFuID0gdHJ1ZVxyXG4gICkgPT4ge1xyXG4gICAgbGV0IGxvY2sgPSBmYWxzZTtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxGaWxlTGlzdCB8IG51bGw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgaW5wdXRFbGVtZW50ID0gZG9jdW1lbnROYXRpdmVBcGkuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcclxuICAgICAgaW5wdXRFbGVtZW50LmlkID0gJ3VwbG9hZC1pbnB1dCcgKyBuZXcgRGF0ZSgpO1xyXG4gICAgICBpbnB1dEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgaW5wdXRFbGVtZW50LnNldEF0dHJpYnV0ZSgndHlwZScsICdmaWxlJyk7XHJcblxyXG4gICAgICBpZiAobXVsdGlwbGUpIHtcclxuICAgICAgICBpbnB1dEVsZW1lbnQuc2V0QXR0cmlidXRlKCdtdWx0aXBsZScsICd0cnVlJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkuYXBwZW5kQ2hpbGQoaW5wdXRFbGVtZW50KTtcclxuXHJcbiAgICAgIGlucHV0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICdjaGFuZ2UnLFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIGxvY2sgPSB0cnVlO1xyXG4gICAgICAgICAgcmVzb2x2ZShpbnB1dEVsZW1lbnQuZmlsZXMpO1xyXG4gICAgICAgICAgLy8gcmVtb3ZlIGZyb20gZG9tXHJcbiAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5ib2R5LnJlbW92ZUNoaWxkKFxyXG4gICAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpIGFzIE5vZGVcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB7IG9uY2U6IHRydWUgfVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gZmlsZSBibHVyXHJcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICdmb2N1cycsXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghbG9jayAmJiBkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpKSB7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignb25ibHVyJykpO1xyXG4gICAgICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIGRvbVxyXG4gICAgICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkucmVtb3ZlQ2hpbGQoXHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpIGFzIE5vZGVcclxuICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LCAzMDApO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgeyBvbmNlOiB0cnVlIH1cclxuICAgICAgKTtcclxuXHJcbiAgICAgIC8vIG9wZW4gZmlsZSBzZWxlY3QgYm94XHJcbiAgICAgIGlucHV0RWxlbWVudC5jbGljaygpO1xyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgc3RhdGljIGNvbXByZXNzID0gKFxyXG4gICAgaW1hZ2VEYXRhVXJsU291cmNlOiBEYXRhVXJsLFxyXG4gICAgb3JpZW50YXRpb246IERPQ19PUklFTlRBVElPTixcclxuICAgIHJlbmRlcjogUmVuZGVyZXIyLFxyXG4gICAgcmF0aW86IG51bWJlciA9IDUwLFxyXG4gICAgcXVhbGl0eTogbnVtYmVyID0gNTAsXHJcbiAgICBtYXh3aWR0aDogbnVtYmVyID0gMCxcclxuICAgIG1heGhlaWdodDogbnVtYmVyID0gMCxcclxuICAgIG1pbWU6IHN0cmluZyA9IFwiXCJcclxuICApOiBQcm9taXNlPHN0cmluZz4gPT5cclxuICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgcXVhbGl0eSA9IHF1YWxpdHkgLyAxMDA7XHJcbiAgICAgIHJhdGlvID0gcmF0aW8gLyAxMDA7XHJcbiAgICAgIGNvbnN0IHNvdXJjZUltYWdlID0gbmV3IEltYWdlKCk7XHJcblxyXG4gICAgICAvLyBpbXBvcnRhbnQgZm9yIHNhZmFyaTogd2UgbmVlZCB0byB3YWl0IGZvciBvbmxvYWQgZXZlbnRcclxuICAgICAgc291cmNlSW1hZ2Uub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSByZW5kZXIuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgY29uc3QgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcblxyXG4gICAgICAgIGlmICghY3R4KSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGBObyBjYW52YXMgY29udGV4dCBhdmFpbGFibGVgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB3ID0gc291cmNlSW1hZ2UubmF0dXJhbFdpZHRoO1xyXG4gICAgICAgIGxldCBoID0gc291cmNlSW1hZ2UubmF0dXJhbEhlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKCFDU1Muc3VwcG9ydHMoJ2ltYWdlLW9yaWVudGF0aW9uJywgJ2Zyb20taW1hZ2UnKSkge1xyXG4gICAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICBvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLlJpZ2h0IHx8XHJcbiAgICAgICAgICAgIG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uTGVmdFxyXG4gICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHQgPSB3O1xyXG4gICAgICAgICAgICB3ID0gaDtcclxuICAgICAgICAgICAgaCA9IHQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgeHJhdGlvID0gbWF4d2lkdGggPyBtYXh3aWR0aCAvIHcgOiAxO1xyXG4gICAgICAgIGxldCB5cmF0aW8gPSBtYXhoZWlnaHQgPyBtYXhoZWlnaHQgLyBoIDogMTtcclxuICAgICAgICByYXRpbyA9IE1hdGgubWluKHJhdGlvLCB4cmF0aW8sIHlyYXRpbyk7XHJcbiAgICAgICAgY2FudmFzLndpZHRoID0gdyAqIHJhdGlvO1xyXG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoICogcmF0aW87XHJcblxyXG4gICAgICAgIGNvbnN0IFRPX1JBRElBTlMgPSBNYXRoLlBJIC8gMTgwO1xyXG5cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICBDU1Muc3VwcG9ydHMoJ2ltYWdlLW9yaWVudGF0aW9uJywgJ2Zyb20taW1hZ2UnKSB8fFxyXG4gICAgICAgICAgb3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5VcFxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcclxuICAgICAgICB9IGVsc2UgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uUmlnaHQpIHtcclxuICAgICAgICAgIGN0eC5zYXZlKCk7XHJcbiAgICAgICAgICBjdHgucm90YXRlKDkwICogVE9fUkFESUFOUyk7XHJcbiAgICAgICAgICBjdHgudHJhbnNsYXRlKDAsIC1jYW52YXMud2lkdGgpO1xyXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLmhlaWdodCwgY2FudmFzLndpZHRoKTtcclxuICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLkxlZnQpIHtcclxuICAgICAgICAgIGN0eC5zYXZlKCk7XHJcbiAgICAgICAgICBjdHgucm90YXRlKC05MCAqIFRPX1JBRElBTlMpO1xyXG4gICAgICAgICAgY3R4LnRyYW5zbGF0ZSgtY2FudmFzLndpZHRoLCAwKTtcclxuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy5oZWlnaHQsIGNhbnZhcy53aWR0aCk7XHJcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5Eb3duKSB7XHJcbiAgICAgICAgICBjdHguc2F2ZSgpO1xyXG4gICAgICAgICAgY3R4LnJvdGF0ZSgxODAgKiBUT19SQURJQU5TKTtcclxuICAgICAgICAgIGN0eC50cmFuc2xhdGUoLWNhbnZhcy53aWR0aCwgLWNhbnZhcy5oZWlnaHQpO1xyXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcclxuICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIG5vIG9yaWVudGF0aW9uIHZhbHVlIGZvdW5kIC0gc2FtZSBhcyBkZWZhdWx0IFVQXHJcbiAgICAgICAgICBjdHguZHJhd0ltYWdlKHNvdXJjZUltYWdlLCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiggbWltZSA9PSBcIlwiICkge1xyXG4gICAgICAgICAgbWltZSA9IGltYWdlRGF0YVVybFNvdXJjZS5zdWJzdHIoXHJcbiAgICAgICAgICAgIDUsXHJcbiAgICAgICAgICAgIGltYWdlRGF0YVVybFNvdXJjZS5zcGxpdCgnOycpWzBdLmxlbmd0aCAtIDVcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFRPRE8gdGVzdCBvbiBtaW1lXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FudmFzLnRvRGF0YVVSTChtaW1lLCBxdWFsaXR5KTtcclxuXHJcbiAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgc291cmNlSW1hZ2Uub25lcnJvciA9IChlKSA9PiByZWplY3QoZSk7XHJcbiAgICAgIHNvdXJjZUltYWdlLnNyYyA9IGltYWdlRGF0YVVybFNvdXJjZTtcclxuICAgIH0pO1xyXG5cclxuICBzdGF0aWMgYnl0ZUNvdW50ID0gKGltZ1N0cmluZzogRGF0YVVybCk6IG51bWJlciA9PlxyXG4gICAgZW5jb2RlVVJJKGltZ1N0cmluZykuc3BsaXQoLyUuLnwuLykubGVuZ3RoIC0gMTtcclxuXHJcbiAgc3RhdGljIGdldEltYWdlTWF4U2l6ZSA9IGFzeW5jIChcclxuICAgIG1heFNpemVNYjogbnVtYmVyLFxyXG4gICAgZGVidWdNb2RlOiBib29sZWFuLFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjJcclxuICApOiBQcm9taXNlPERhdGFVcmw+ID0+IHtcclxuICAgIGNvbnN0IE1BWF9UUklFUyA9IDEwO1xyXG5cclxuICAgIGNvbnN0IGJ5dGVzVG9NQiA9IChieXRlczogbnVtYmVyKSA9PiAoYnl0ZXMgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKTtcclxuXHJcbiAgICBpZiAoZGVidWdNb2RlKSB7XHJcbiAgICAgIGNvbnNvbGUuZGVidWcoJ05neEltYWdlQ29tcHJlc3MgLSBPcGVuaW5nIHVwbG9hZCB3aW5kb3cnKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgbXlGaWxlOiBVcGxvYWRSZXNwb25zZSA9IChhd2FpdCBJbWFnZUNvbXByZXNzLnVwbG9hZEZpbGUoXHJcbiAgICAgIHJlbmRlcixcclxuICAgICAgZmFsc2VcclxuICAgICkpIGFzIFVwbG9hZFJlc3BvbnNlO1xyXG5cclxuICAgIGxldCBjb21wcmVzc2VkRmlsZTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1BWF9UUklFUzsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IHByZXZpb3VzU2l6ZSA9IEltYWdlQ29tcHJlc3MuYnl0ZUNvdW50KG15RmlsZS5pbWFnZSk7XHJcbiAgICAgIGNvbXByZXNzZWRGaWxlID0gYXdhaXQgSW1hZ2VDb21wcmVzcy5jb21wcmVzcyhcclxuICAgICAgICBteUZpbGUuaW1hZ2UsXHJcbiAgICAgICAgbXlGaWxlLm9yaWVudGF0aW9uLFxyXG4gICAgICAgIHJlbmRlcixcclxuICAgICAgICA1MCxcclxuICAgICAgICAxMDBcclxuICAgICAgKTtcclxuICAgICAgY29uc3QgbmV3U2l6ZSA9IEltYWdlQ29tcHJlc3MuYnl0ZUNvdW50KGNvbXByZXNzZWRGaWxlKTtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhcclxuICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcclxuICAgICAgICAnQ29tcHJlc3Npb24gZnJvbScsXHJcbiAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXHJcbiAgICAgICAgJ01CIHRvJyxcclxuICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgJ01CJ1xyXG4gICAgICApO1xyXG4gICAgICBpZiAobmV3U2l6ZSA+PSBwcmV2aW91c1NpemUpIHtcclxuICAgICAgICBpZiAoaSA9PT0gMCkge1xyXG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgICAgICdOZ3hJbWFnZUNvbXByZXNzIC0nLFxyXG4gICAgICAgICAgICAgIFwiRmlsZSBjYW4ndCBiZSByZWR1Y2VkIGF0IGFsbCAtIHJldHVybmluZyB0aGUgb3JpZ2luYWxcIixcclxuICAgICAgICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcclxuICAgICAgICAgICAgICAnTUIgbGFyZ2UnXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aHJvdyBteUZpbGUuaW1hZ2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcclxuICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcclxuICAgICAgICAgICAgICBcIkZpbGUgY2FuJ3QgYmUgcmVkdWNlZCBtb3JlIC0gcmV0dXJuaW5nIHRoZSBiZXN0IHdlIGNhbiwgd2hpY2ggaXMgXCIsXHJcbiAgICAgICAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXHJcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdGhyb3cgbXlGaWxlLmltYWdlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAobmV3U2l6ZSA8IG1heFNpemVNYiAqIDEwMjQgKiAxMDI0KSB7XHJcbiAgICAgICAgICBpZiAoZGVidWdNb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXHJcbiAgICAgICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXHJcbiAgICAgICAgICAgICAgJ0hlcmUgeW91ciBmaWxlJyxcclxuICAgICAgICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNvbXByZXNzZWRGaWxlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaSA9PT0gOSkge1xyXG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgICAgICdOZ3hJbWFnZUNvbXByZXNzIC0nLFxyXG4gICAgICAgICAgICAgIFwiRmlsZSBjYW4ndCByZWFjaCB0aGUgZGVzaXJlZCBzaXplIGFmdGVyXCIsXHJcbiAgICAgICAgICAgICAgTUFYX1RSSUVTLFxyXG4gICAgICAgICAgICAgICd0cmllcy4gUmV0dXJuaW5nIGZpbGUgJyxcclxuICAgICAgICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcclxuICAgICAgICAgICAgICAnTUIgbGFyZ2UnXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aHJvdyBteUZpbGUuaW1hZ2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKFxyXG4gICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXHJcbiAgICAgICAgICAnUmVhY2hlZCcsXHJcbiAgICAgICAgICBieXRlc1RvTUIobmV3U2l6ZSksXHJcbiAgICAgICAgICAnTUIgbGFyZ2UuIFRyeWluZyBhbm90aGVyIHRpbWUgYWZ0ZXInLFxyXG4gICAgICAgICAgaSArIDEsXHJcbiAgICAgICAgICAndGltZXMnXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICBteUZpbGUuaW1hZ2UgPSBjb21wcmVzc2VkRmlsZTtcclxuICAgIH1cclxuICAgIGlmIChkZWJ1Z01vZGUpIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZygnTmd4SW1hZ2VDb21wcmVzcyAtIFVuZXhwZWN0ZWQgZXJyb3InKTtcclxuICAgIH1cclxuICAgIHRocm93ICcnO1xyXG4gIH07XHJcbn1cclxuIl19