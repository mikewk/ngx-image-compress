{"version":3,"file":"ngx-image-compress.mjs","sources":["../../../projects/ngx-image-compress/src/lib/models/DOC_ORIENTATION.ts","../../../projects/ngx-image-compress/src/lib/image-compress.ts","../../../projects/ngx-image-compress/src/lib/ngx-image-compress.service.ts","../../../projects/ngx-image-compress/src/public-api.ts","../../../projects/ngx-image-compress/src/ngx-image-compress.ts"],"sourcesContent":["/**\r\n * EXIF tag standard reference\r\n *\r\n * Tag Name: Orientation\r\n * Tag ID: 0x0112\r\n * Writable: int16u\r\n * Group: IFD0\r\n * Values:\r\n 1 = Horizontal (normal)\r\n 2 = Mirror horizontal\r\n 3 = Rotate 180\r\n 4 = Mirror vertical\r\n 5 = Mirror horizontal and rotate 270 CW\r\n 6 = Rotate 90 CW\r\n 7 = Mirror horizontal and rotate 90 CW\r\n 8 = Rotate 270 CW\r\n */\r\nexport enum DOC_ORIENTATION {\r\n  Up = 1,                     //Horizontal (normal)\r\n  Down = 3,                   //Rotate 180\r\n  Right = 6,                  //Rotate 90 CW\r\n  Left = 8,                   //Rotate 270 CW\r\n  UpMirrored = 2,             //Mirror horizontal\r\n  DownMirrored = 4,           //Mirror vertical\r\n  LeftMirrored = 5,           //Mirror horizontal and rotate 270 CW\r\n  RightMirrored = 7,          //Mirror horizontal and rotate 90 CW\r\n  Default = 0,\r\n  NotJpeg = -1,\r\n  NotDefined = -2\r\n}\r\n\r\n","import { Renderer2 } from '@angular/core';\r\nimport { DataUrl } from './models/data-url';\r\nimport { DOC_ORIENTATION } from './models/DOC_ORIENTATION';\r\nimport { UploadResponse } from './models/upload-response';\r\n\r\nexport class ImageCompress {\r\n  static getOrientation = (file: File): Promise<DOC_ORIENTATION> =>\r\n    new Promise<DOC_ORIENTATION>((resolve, reject) => {\r\n      try {\r\n        const reader = new FileReader();\r\n        reader.onload = () => {\r\n          const view = new DataView(reader.result as ArrayBuffer);\r\n          if (!view.byteLength) {\r\n            return resolve(DOC_ORIENTATION.NotDefined);\r\n          }\r\n          if (view.getUint16(0, false) !== 0xffd8) {\r\n            return resolve(DOC_ORIENTATION.NotDefined);\r\n          }\r\n          const length = view.byteLength;\r\n          let offset = 2;\r\n          while (offset < length) {\r\n            const marker = view.getUint16(offset, false);\r\n            offset += 2;\r\n            if (marker === 0xffe1) {\r\n              if (view.getUint32((offset += 2), false) !== 0x45786966) {\r\n                return resolve(DOC_ORIENTATION.NotJpeg);\r\n              }\r\n              const little = view.getUint16((offset += 6), false) === 0x4949;\r\n              offset += view.getUint32(offset + 4, little);\r\n              const tags = view.getUint16(offset, little);\r\n              offset += 2;\r\n              for (let i = 0; i < tags; i++) {\r\n                if (view.getUint16(offset + i * 12, little) === 0x0112) {\r\n                  return resolve(view.getUint16(offset + i * 12 + 8, little));\r\n                }\r\n              }\r\n            } else if ((marker & 0xff00) !== 0xff00) {\r\n              break;\r\n            } else {\r\n              offset += view.getUint16(offset, false);\r\n            }\r\n          }\r\n          return resolve(DOC_ORIENTATION.NotJpeg);\r\n        };\r\n        reader.readAsArrayBuffer(file);\r\n      } catch (e) {\r\n        return reject(DOC_ORIENTATION.Default);\r\n      }\r\n    });\r\n\r\n  static uploadFile = (\r\n    render: Renderer2,\r\n    multiple: boolean = true\r\n  ): Promise<UploadResponse | UploadResponse[]> =>\r\n    new Promise(function (resolve, reject) {\r\n      const isSafari = /^((?!chrome|android).)*safari/i.test(\r\n        navigator.userAgent\r\n      );\r\n\r\n      Promise.resolve(isSafari)\r\n        .then((onlyNative) => {\r\n          if (onlyNative) {\r\n            return ImageCompress.generateUploadInputNative(\r\n              window.document,\r\n              multiple\r\n            );\r\n          } else {\r\n            return ImageCompress.generateUploadInputRenderer(render, multiple);\r\n          }\r\n        })\r\n        .then((filesList: FileList | null) => {\r\n          const files = filesList ? Array.from(filesList) : [];\r\n          const orientationPromises = files.map((file) =>\r\n            ImageCompress.getOrientation(file)\r\n          );\r\n          const readerPromises = files.map((file) =>\r\n            ImageCompress.fileToDataURL(file)\r\n          );\r\n\r\n          let orientationsResult: DOC_ORIENTATION[] = [];\r\n\r\n          Promise.all(orientationPromises)\r\n            .then((orientations: DOC_ORIENTATION[]) => {\r\n              orientationsResult = orientations;\r\n              return Promise.all(readerPromises);\r\n            })\r\n            .then((readerResult) => {\r\n              if (multiple) {\r\n                const result = readerResult.map((image, index) => ({\r\n                  image,\r\n                  orientation: orientationsResult[index],\r\n                }));\r\n                resolve(result);\r\n              } else {\r\n                resolve({\r\n                  image: readerResult[0],\r\n                  orientation: orientationsResult[0],\r\n                });\r\n              }\r\n            });\r\n        });\r\n    });\r\n\r\n  static fileToDataURL = (file: File): Promise<string> => {\r\n    return new Promise<string>((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = (e: any) => {\r\n        //myReader.onloadend = (progressEvent: ProgressEvent<FileReader>)\r\n        resolve(e.target.result);\r\n      };\r\n      try {\r\n        reader.readAsDataURL(file);\r\n      } catch (e) {\r\n        reject(\r\n          `ngx-image-compress - probably no file have been selected: ${e}`\r\n        );\r\n      }\r\n    });\r\n  };\r\n\r\n  static generateUploadInputRenderer = (\r\n    render: Renderer2,\r\n    multiple: boolean = true\r\n  ) =>\r\n    new Promise<FileList | null>((resolve, reject) => {\r\n      const inputElement = render.createElement('input');\r\n      render.setStyle(inputElement, 'display', 'none');\r\n      render.setProperty(inputElement, 'type', 'file');\r\n      render.setProperty(inputElement, 'accept', 'image/*');\r\n\r\n      if (multiple) {\r\n        render.setProperty(inputElement, 'multiple', 'true');\r\n      }\r\n\r\n      render.listen(inputElement, 'click', ($event: MouseEvent) => {\r\n        ($event.target as any as HTMLInputElement).value = '';\r\n      });\r\n\r\n      render.listen(inputElement, 'change', ($event) => {\r\n        const files: FileList = $event.target.files;\r\n        resolve(files);\r\n      });\r\n      inputElement.click();\r\n    });\r\n\r\n  static generateUploadInputNative = (\r\n    documentNativeApi: any,\r\n    multiple: boolean = true\r\n  ) => {\r\n    let lock = false;\r\n    return new Promise<FileList | null>((resolve, reject) => {\r\n      const inputElement = documentNativeApi.createElement('input');\r\n      inputElement.id = 'upload-input' + new Date();\r\n      inputElement.style.display = 'none';\r\n      inputElement.setAttribute('type', 'file');\r\n\r\n      if (multiple) {\r\n        inputElement.setAttribute('multiple', 'true');\r\n      }\r\n\r\n      documentNativeApi.body.appendChild(inputElement);\r\n\r\n      inputElement.addEventListener(\r\n        'change',\r\n        () => {\r\n          lock = true;\r\n          resolve(inputElement.files);\r\n          // remove from dom\r\n          documentNativeApi.body.removeChild(\r\n            documentNativeApi.getElementById(inputElement.id) as Node\r\n          );\r\n        },\r\n        { once: true }\r\n      );\r\n\r\n      // file blur\r\n      window.addEventListener(\r\n        'focus',\r\n        () => {\r\n          setTimeout(() => {\r\n            if (!lock && documentNativeApi.getElementById(inputElement.id)) {\r\n              reject(new Error('onblur'));\r\n              // remove from dom\r\n              documentNativeApi.body.removeChild(\r\n                documentNativeApi.getElementById(inputElement.id) as Node\r\n              );\r\n            }\r\n          }, 300);\r\n        },\r\n        { once: true }\r\n      );\r\n\r\n      // open file select box\r\n      inputElement.click();\r\n    });\r\n  };\r\n\r\n  static compress = (\r\n    imageDataUrlSource: DataUrl,\r\n    orientation: DOC_ORIENTATION,\r\n    render: Renderer2,\r\n    ratio: number = 50,\r\n    quality: number = 50,\r\n    maxwidth: number = 0,\r\n    maxheight: number = 0,\r\n    mime: string = \"\"\r\n  ): Promise<string> =>\r\n    new Promise(function (resolve, reject) {\r\n      quality = quality / 100;\r\n      ratio = ratio / 100;\r\n      const sourceImage = new Image();\r\n\r\n      // important for safari: we need to wait for onload event\r\n      sourceImage.onload = () => {\r\n        const canvas: HTMLCanvasElement = render.createElement('canvas');\r\n        const ctx: CanvasRenderingContext2D | null = canvas.getContext('2d');\r\n\r\n        if (!ctx) {\r\n          return reject(`No canvas context available`);\r\n        }\r\n\r\n        let w = sourceImage.naturalWidth;\r\n        let h = sourceImage.naturalHeight;\r\n\r\n        if (!CSS.supports('image-orientation', 'from-image')) {\r\n          if (\r\n            orientation === DOC_ORIENTATION.Right ||\r\n            orientation === DOC_ORIENTATION.Left\r\n          ) {\r\n            const t = w;\r\n            w = h;\r\n            h = t;\r\n          }\r\n        }\r\n\r\n        let xratio = maxwidth ? maxwidth / w : 1;\r\n        let yratio = maxheight ? maxheight / h : 1;\r\n        ratio = Math.min(ratio, xratio, yratio);\r\n        canvas.width = w * ratio;\r\n        canvas.height = h * ratio;\r\n\r\n        const TO_RADIANS = Math.PI / 180;\r\n\r\n        if (\r\n          CSS.supports('image-orientation', 'from-image') ||\r\n          orientation === DOC_ORIENTATION.Up\r\n        ) {\r\n          ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);\r\n        } else if (orientation === DOC_ORIENTATION.Right) {\r\n          ctx.save();\r\n          ctx.rotate(90 * TO_RADIANS);\r\n          ctx.translate(0, -canvas.width);\r\n          ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);\r\n          ctx.restore();\r\n        } else if (orientation === DOC_ORIENTATION.Left) {\r\n          ctx.save();\r\n          ctx.rotate(-90 * TO_RADIANS);\r\n          ctx.translate(-canvas.width, 0);\r\n          ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);\r\n          ctx.restore();\r\n        } else if (orientation === DOC_ORIENTATION.Down) {\r\n          ctx.save();\r\n          ctx.rotate(180 * TO_RADIANS);\r\n          ctx.translate(-canvas.width, -canvas.height);\r\n          ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);\r\n          ctx.restore();\r\n        } else {\r\n          // no orientation value found - same as default UP\r\n          ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);\r\n        }\r\n        if( mime == \"\" ) {\r\n          mime = imageDataUrlSource.substr(\r\n            5,\r\n            imageDataUrlSource.split(';')[0].length - 5\r\n          );\r\n        }\r\n        // TODO test on mime\r\n        const result = canvas.toDataURL(mime, quality);\r\n\r\n        resolve(result);\r\n      };\r\n\r\n      sourceImage.onerror = (e) => reject(e);\r\n      sourceImage.src = imageDataUrlSource;\r\n    });\r\n\r\n  static byteCount = (imgString: DataUrl): number =>\r\n    encodeURI(imgString).split(/%..|./).length - 1;\r\n\r\n  static getImageMaxSize = async (\r\n    maxSizeMb: number,\r\n    debugMode: boolean,\r\n    render: Renderer2\r\n  ): Promise<DataUrl> => {\r\n    const MAX_TRIES = 10;\r\n\r\n    const bytesToMB = (bytes: number) => (bytes / 1024 / 1024).toFixed(2);\r\n\r\n    if (debugMode) {\r\n      console.debug('NgxImageCompress - Opening upload window');\r\n    }\r\n\r\n    let myFile: UploadResponse = (await ImageCompress.uploadFile(\r\n      render,\r\n      false\r\n    )) as UploadResponse;\r\n\r\n    let compressedFile;\r\n\r\n    for (let i = 0; i < MAX_TRIES; i++) {\r\n      const previousSize = ImageCompress.byteCount(myFile.image);\r\n      compressedFile = await ImageCompress.compress(\r\n        myFile.image,\r\n        myFile.orientation,\r\n        render,\r\n        50,\r\n        100\r\n      );\r\n      const newSize = ImageCompress.byteCount(compressedFile);\r\n      console.debug(\r\n        'NgxImageCompress -',\r\n        'Compression from',\r\n        bytesToMB(previousSize),\r\n        'MB to',\r\n        bytesToMB(newSize),\r\n        'MB'\r\n      );\r\n      if (newSize >= previousSize) {\r\n        if (i === 0) {\r\n          if (debugMode) {\r\n            console.debug(\r\n              'NgxImageCompress -',\r\n              \"File can't be reduced at all - returning the original\",\r\n              bytesToMB(previousSize),\r\n              'MB large'\r\n            );\r\n          }\r\n          throw myFile.image;\r\n        } else {\r\n          if (debugMode) {\r\n            console.debug(\r\n              'NgxImageCompress -',\r\n              \"File can't be reduced more - returning the best we can, which is \",\r\n              bytesToMB(previousSize),\r\n              'MB large'\r\n            );\r\n          }\r\n          throw myFile.image;\r\n        }\r\n      } else {\r\n        if (newSize < maxSizeMb * 1024 * 1024) {\r\n          if (debugMode) {\r\n            console.debug(\r\n              'NgxImageCompress -',\r\n              'Here your file',\r\n              bytesToMB(newSize),\r\n              'MB large'\r\n            );\r\n          }\r\n          return compressedFile;\r\n        } else if (i === 9) {\r\n          if (debugMode) {\r\n            console.debug(\r\n              'NgxImageCompress -',\r\n              \"File can't reach the desired size after\",\r\n              MAX_TRIES,\r\n              'tries. Returning file ',\r\n              bytesToMB(previousSize),\r\n              'MB large'\r\n            );\r\n          }\r\n          throw myFile.image;\r\n        }\r\n      }\r\n      if (debugMode) {\r\n        console.debug(\r\n          'NgxImageCompress -',\r\n          'Reached',\r\n          bytesToMB(newSize),\r\n          'MB large. Trying another time after',\r\n          i + 1,\r\n          'times'\r\n        );\r\n      }\r\n      myFile.image = compressedFile;\r\n    }\r\n    if (debugMode) {\r\n      console.debug('NgxImageCompress - Unexpected error');\r\n    }\r\n    throw '';\r\n  };\r\n}\r\n","import {Injectable, Renderer2, RendererFactory2} from '@angular/core';\r\nimport {ImageCompress} from './image-compress';\r\nimport {DOC_ORIENTATION} from './models/DOC_ORIENTATION';\r\nimport {UploadResponse} from './models/upload-response';\r\nimport {DataUrl} from './models/data-url';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NgxImageCompressService {\r\n\r\n  private readonly render: Renderer2;\r\n\r\n  public DOC_ORIENTATION = DOC_ORIENTATION;\r\n\r\n  constructor(rendererFactory: RendererFactory2) {\r\n    this.render = rendererFactory.createRenderer(null, null);\r\n  }\r\n\r\n  /**\r\n   * helper to evaluate the compression rate\r\n   * @param imgString the image in base64 string format\r\n   */\r\n  public byteCount(image: DataUrl) {\r\n    return ImageCompress.byteCount(image);\r\n  }\r\n\r\n  /**\r\n   * Get the correct Orientation value from image tags\r\n   */\r\n  public getOrientation(file: File): Promise<DOC_ORIENTATION> {\r\n    return ImageCompress.getOrientation(file);\r\n  }\r\n\r\n  /**\r\n   * return a promise with the new image data and image orientation\r\n   */\r\n  public uploadFile(): Promise<UploadResponse> {\r\n    return ImageCompress.uploadFile(this.render, false) as Promise<UploadResponse>;\r\n  }\r\n\r\n  /**\r\n   * return a promise with an array of image data and image orientation\r\n   */\r\n  public uploadMultipleFiles(): Promise<UploadResponse[]> {\r\n    return ImageCompress.uploadFile(this.render, true) as Promise<UploadResponse[]>;\r\n  }\r\n\r\n  /**\r\n   * perform a compression from the given DataUrl (string), provided by the uploadFile, or uploadMultipleFiles method\r\n   *\r\n   *\r\n   | Parameter   | Type   | Description                                                                       |\r\n   | ----------- | ------ | --------------------------------------------------------------------------------- |\r\n   | image       | string | DataUrl (string) representing the image                                           |\r\n   | orientation | number | EXIF Orientation value using the DOC_ORIENTATION enum value                       |\r\n   | ratio       | number | Maximum scale factor as a percentage (optional, default: 50) <sup>[1](#fn1)</sup> |\r\n   | quality     | number | JPEG quality factor as a percentage (optional, default: 50) <sup>[2](#fn2)</sup>  |\r\n   | maxwidth    | number | Maximum width in pixels if you need to resize (optional, default: 0 - no resize)  |\r\n   | maxheight   | number | Maximum height in pixels if you need to resize (optional, default: 0 - no resize) |\r\n   */\r\n  public compressFile(\r\n    image: DataUrl,\r\n    orientation: DOC_ORIENTATION,\r\n    ratio: number = 50,\r\n    quality: number = 50,\r\n    maxWidth: number = 0,\r\n    maxHeight: number = 0,\r\n    mime: string = \"\"\r\n  ): Promise<DataUrl> {\r\n    return ImageCompress.compress(image, orientation, this.render, ratio, quality, maxWidth, maxHeight, mime);\r\n  }\r\n\r\n  /**\r\n   * Most simple function to use here.\r\n   * Perform an upload and return an image dataUrl (string format) with a maximum size, given in *MegaBytes*\r\n   * If the size can't be reached, the best that can be reached will be returned in promise *rejection*\r\n   * Put debugMode to true if you have some trouble to print some help using console.debug\r\n   */\r\n  public uploadAndGetImageWithMaxSize(maxSizeMb: number = 1, debugMode = false): Promise<DataUrl> {\r\n    return ImageCompress.getImageMaxSize(maxSizeMb, debugMode, this.render);\r\n  }\r\n}\r\n","/*\r\n * Public API Surface of ngx-image-compress\r\n */\r\n\r\nexport * from './lib/ngx-image-compress.service';\r\nexport * from './lib/models/DOC_ORIENTATION';\r\nexport * from './lib/models/upload-response';\r\nexport * from './lib/models/data-url';\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}